<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <title>Payroll Pro - Global Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .no-select { user-select: none; -webkit-user-select: none; }
        .lang-btn.active { border-color: #3b82f6; color: #3b82f6; background: rgba(59, 130, 246, 0.15); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .loader { border: 4px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Evita que el fondo de los selectores nativos se vea mal en iOS/Android */
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen no-select flex flex-col font-sans">

    <div id="ad-overlay" class="fixed inset-0 bg-slate-950/95 z-[1000] hidden flex-col justify-center items-center backdrop-blur-sm">
        <div class="loader mb-6"></div>
        <h2 data-i18n="ad_processing" class="text-xs font-black text-blue-400 uppercase tracking-[0.3em]">Procesando C√°lculo</h2>
        <div class="mt-6 bg-blue-600/20 px-8 py-3 rounded-full border border-blue-500/30">
            <span id="ad-timer" class="text-3xl font-black text-blue-400">5</span>
        </div>
        <p data-i18n="ad_space" class="text-[9px] text-slate-500 mt-8 uppercase tracking-widest">Espacio Publicitario</p>
    </div>

    <header class="p-4 bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-md">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xs font-black text-blue-400 uppercase tracking-tighter"><i class="fa-solid fa-calculator mr-1"></i> Payroll Pro</h1>
            <div class="flex gap-1.5" id="lang-controls">
                <button onclick="setLanguage('es')" id="btn-lang-es" class="lang-btn text-[9px] font-bold border border-slate-700 px-2.5 py-1.5 rounded-lg transition-colors">ES</button>
                <button onclick="setLanguage('en')" id="btn-lang-en" class="lang-btn text-[9px] font-bold border border-slate-700 px-2.5 py-1.5 rounded-lg transition-colors">EN</button>
                <button onclick="setLanguage('it')" id="btn-lang-it" class="lang-btn text-[9px] font-bold border border-slate-700 px-2.5 py-1.5 rounded-lg transition-colors">IT</button>
                <button onclick="setLanguage('pt')" id="btn-lang-pt" class="lang-btn text-[9px] font-bold border border-slate-700 px-2.5 py-1.5 rounded-lg transition-colors">PT</button>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-lg mx-auto w-full flex-grow flex flex-col">
        <div class="flex bg-slate-800 p-1 rounded-2xl mb-6 border border-slate-700">
            <button onclick="setMode('mes')" id="mode-mes" data-i18n="mode_month" class="flex-1 py-3 rounded-xl bg-blue-600 font-bold text-[10px] uppercase transition-all">Mensual</button>
            <button onclick="setMode('semana')" id="mode-semana" data-i18n="mode_week" class="flex-1 py-3 rounded-xl font-bold text-slate-500 text-[10px] uppercase transition-all hover:text-slate-300">Semanal</button>
            <button onclick="setMode('horas')" id="mode-horas" data-i18n="mode_hour" class="flex-1 py-3 rounded-xl font-bold text-slate-500 text-[10px] uppercase transition-all hover:text-slate-300">Horas</button>
        </div>

        <div class="space-y-4">
            <div class="bg-slate-800/60 p-4 rounded-2xl border border-slate-700 relative">
                <label data-i18n="lbl_country" class="text-[9px] font-black text-slate-400 uppercase tracking-widest block mb-2">Pa√≠s Fiscal</label>
                <select id="country-select" onchange="updateAdvancedVisibility()" class="w-full bg-transparent text-lg font-bold outline-none text-white cursor-pointer relative z-10">
                    <option value="ES">Espa√±a üá™üá∏</option>
                    <option value="UK">United Kingdom üá¨üáß</option>
                    <option value="IT">Italia üáÆüáπ</option>
                    <option value="PT">Portugal üáµüáπ</option>
                </select>
                <div class="absolute right-4 top-1/2 mt-1 text-slate-500 pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-800/60 p-4 rounded-2xl border border-slate-700">
                    <label id="lbl-gross" data-i18n="lbl_gross" class="text-[9px] font-black text-slate-400 uppercase block mb-1">Sueldo Bruto</label>
                    <input type="number" id="input-gross" class="w-full bg-transparent text-2xl font-black outline-none text-blue-400" placeholder="0.00">
                </div>
                <div class="bg-slate-800/60 p-4 rounded-2xl border border-slate-700">
                    <label id="lbl-time" data-i18n="lbl_time" class="text-[9px] font-black text-slate-400 uppercase block mb-1">D√≠as</label>
                    <input type="number" id="input-time" class="w-full bg-transparent text-2xl font-black outline-none text-white" placeholder="30">
                </div>
            </div>

            <button onclick="toggleAdvanced()" class="w-full py-4 rounded-xl border border-slate-700 bg-slate-800/30 text-[9px] font-black text-slate-400 uppercase tracking-widest hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-sliders mr-2"></i> <span data-i18n="btn_adv">Opciones Avanzadas</span>
            </button>

            <div id="advanced-container" class="hidden space-y-4 bg-slate-800/40 p-5 rounded-2xl border border-dashed border-slate-600">
                
                <div id="adv-ES" class="adv-panel hidden">
                    <label data-i18n="es_irpf" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">Retenci√≥n IRPF (%)</label>
                    <input type="number" id="es-irpf-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold placeholder-slate-600">
                </div>

                <div id="adv-UK" class="adv-panel hidden space-y-4">
                    <div class="flex justify-between items-center bg-slate-900/60 p-3 rounded-xl border border-slate-700">
                        <label data-i18n="uk_2job" class="text-[10px] font-bold text-slate-300 uppercase">¬øSegundo Empleo?</label>
                        <input type="checkbox" id="uk-2job-val" class="w-5 h-5 accent-blue-500 cursor-pointer">
                    </div>
                    <div>
                        <label data-i18n="uk_pension" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">Aportaci√≥n Pensi√≥n (%)</label>
                        <input type="number" id="uk-pension-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold placeholder-slate-600" placeholder="5">
                    </div>
                </div>

                <div id="adv-IT" class="adv-panel hidden space-y-4">
                    <div>
                        <label data-i18n="it_reg" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">Addizionale Regionale (%)</label>
                        <input type="number" id="it-reg-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold placeholder-slate-600" placeholder="1.23">
                    </div>
                    <div>
                        <label data-i18n="it_com" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">Addizionale Comunale (%)</label>
                        <input type="number" id="it-com-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold placeholder-slate-600" placeholder="0.8">
                    </div>
                </div>

                <div id="adv-PT" class="adv-panel hidden space-y-4">
                    <div class="relative">
                        <label data-i18n="pt_status" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">Estado Civil</label>
                        <select id="pt-status-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold relative z-10 cursor-pointer">
                            <option value="solteiro" data-i18n="pt_single">Soltero / No Casado</option>
                            <option value="casado" data-i18n="pt_married">Casado</option>
                        </select>
                        <div class="absolute right-3 top-9 text-slate-500 pointer-events-none"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                    </div>
                    <div>
                        <label data-i18n="pt_dep" class="text-[10px] font-bold text-blue-400 uppercase block mb-2">N√∫mero de Hijos (Dependientes)</label>
                        <input type="number" id="pt-dep-val" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-xl outline-none text-sm font-bold placeholder-slate-600" placeholder="0">
                    </div>
                </div>
            </div>

            <button onclick="triggerCalculation()" data-i18n="btn_calc" class="w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-3xl text-lg font-black uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(37,99,235,0.3)] transition-all active:scale-95">
                Calcular Neto
            </button>
        </div>

        <section id="results-card" class="hidden mt-8 mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="bg-gradient-to-br from-blue-800 to-indigo-950 rounded-[2.5rem] p-8 shadow-2xl border border-blue-500/20 relative overflow-hidden">
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl"></div>
                
                <p data-i18n="res_title" class="text-[9px] font-black text-blue-300 uppercase tracking-[0.4em] mb-2 relative z-10">Neto Estimado Final</p>
                <h2 id="out-net" class="text-6xl font-black text-white mb-8 tracking-tighter relative z-10">0.00</h2>
                
                <div class="space-y-4 text-xs font-bold border-t border-white/10 pt-6 relative z-10">
                    <div class="flex justify-between text-slate-300"><span data-i18n="res_gross">Bruto Total:</span><span id="out-gross">0.00</span></div>
                    <div class="flex justify-between text-red-300"><span data-i18n="res_ss">Seguridad Social:</span><span id="out-ss">-0.00</span></div>
                    <div class="flex justify-between text-red-300"><span data-i18n="res_tax">Impuestos:</span><span id="out-tax">-0.00</span></div>
                </div>
            </div>
        </section>

        <footer class="mt-auto pt-8 pb-4 text-center">
            <p data-i18n="legal_disclaimer" class="text-[8px] text-slate-500 uppercase tracking-wider leading-relaxed">
                ‚ö†Ô∏è Las cifras generadas son estimaciones. Esta aplicaci√≥n no ofrece asesoramiento fiscal ni legal oficial. Consulte a un profesional para su caso espec√≠fico.
            </p>
        </footer>
    </main>

    <script>
        "use strict";

        // Diccionario de Traducciones Estricto
        const translations = {
            es: {
                mode_month: "Mensual", mode_week: "Semanal", mode_hour: "Horas",
                lbl_country: "Pa√≠s Fiscal", lbl_gross: "Sueldo Bruto", lbl_time: "D√≠as / Tiempo",
                btn_adv: "Opciones Avanzadas", btn_calc: "Calcular Neto",
                es_irpf: "IRPF Manual (%)", uk_2job: "¬øSegundo Empleo?", uk_pension: "Pensi√≥n (%)",
                it_reg: "Addizionale Regionale (%)", it_com: "Addizionale Comunale (%)",
                pt_status: "Estado Civil", pt_single: "Soltero / No Casado", pt_married: "Casado", pt_dep: "N¬∫ de Hijos (Dependientes)",
                res_title: "Neto Estimado Final", res_gross: "Sueldo Bruto:", res_ss: "Seguridad Social:", res_tax: "Impuestos (Retenci√≥n):",
                ad_processing: "Procesando C√°lculo", ad_space: "Espacio Publicitario",
                legal_disclaimer: "‚ö†Ô∏è Las cifras generadas son estimaciones. Esta aplicaci√≥n no ofrece asesoramiento fiscal ni legal oficial. Consulte a un profesional para su caso espec√≠fico."
            },
            en: {
                mode_month: "Monthly", mode_week: "Weekly", mode_hour: "Hourly",
                lbl_country: "Tax Residency", lbl_gross: "Gross Salary", lbl_time: "Days / Hours",
                btn_adv: "Advanced Settings", btn_calc: "Calculate Net Pay",
                es_irpf: "Manual Tax (%)", uk_2job: "Is this a Second Job?", uk_pension: "Pension Contribution (%)",
                it_reg: "Regional Tax (%)", it_com: "Municipal Tax (%)",
                pt_status: "Marital Status", pt_single: "Single", pt_married: "Married", pt_dep: "Number of Dependents",
                res_title: "Estimated Take-Home Pay", res_gross: "Gross Total:", res_ss: "National Insurance / SS:", res_tax: "Income Tax:",
                ad_processing: "Processing Calculation", ad_space: "Advertisement Space",
                legal_disclaimer: "‚ö†Ô∏è Figures generated are estimates only. This application does not provide official tax or legal advice. Consult a professional."
            },
            it: {
                mode_month: "Mensile", mode_week: "Settimanale", mode_hour: "Orario",
                lbl_country: "Paese Fiscale", lbl_gross: "Stipendio Lordo", lbl_time: "Giorni / Ore",
                btn_adv: "Opzioni Avanzate", btn_calc: "Calcola Netto",
                es_irpf: "IRPEF Manuale (%)", uk_2job: "Secondo Lavoro?", uk_pension: "Pensione (%)",
                it_reg: "Addizionale Regionale (%)", it_com: "Addizionale Comunale (%)",
                pt_status: "Stato Civile", pt_single: "Celibe / Nubile", pt_married: "Coniugato/a", pt_dep: "Figli a Carico",
                res_title: "Stipendio Netto Stimato", res_gross: "Lordo Totale:", res_ss: "Contributi INPS:", res_tax: "Trattenute IRPEF:",
                ad_processing: "Elaborazione in corso", ad_space: "Spazio Pubblicitario",
                legal_disclaimer: "‚ö†Ô∏è Le cifre generate sono stime. Questa applicazione non fornisce consulenza fiscale o legale ufficiale. Consultare un professionista."
            },
            pt: {
                mode_month: "Mensal", mode_week: "Semanal", mode_hour: "Por Hora",
                lbl_country: "Pa√≠s Fiscal", lbl_gross: "Vencimento Bruto", lbl_time: "Dias / Horas",
                btn_adv: "Op√ß√µes Avan√ßadas", btn_calc: "Calcular Sal√°rio L√≠quido",
                es_irpf: "Reten√ß√£o Manual (%)", uk_2job: "2¬∫ Emprego?", uk_pension: "Pens√£o (%)",
                it_reg: "Taxa Regional (%)", it_com: "Taxa Municipal (%)",
                pt_status: "Estado Civil", pt_single: "Solteiro(a)", pt_married: "Casado(a)", pt_dep: "N√∫mero de Dependentes",
                res_title: "Sal√°rio L√≠quido Estimado", res_gross: "Bruto Total:", res_ss: "Seguran√ßa Social:", res_tax: "Reten√ß√£o IRS:",
                ad_processing: "A Processar C√°lculo", ad_space: "Espa√ßo Publicit√°rio",
                legal_disclaimer: "‚ö†Ô∏è Os valores gerados s√£o estimativas. Esta aplica√ß√£o n√£o oferece aconselhamento fiscal ou legal oficial. Consulte um profissional."
            }
        };

        // Estado Global
        let currentLang = 'es';
        let currentMode = 'mes';
        let calculationCount = 0;

        // 1. Motor de Traducci√≥n
        function setLanguage(lang) {
            currentLang = lang;
            const dict = translations[lang];

            // Traducir todos los elementos con atributo data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (dict[key]) {
                    element.textContent = dict[key];
                }
            });

            // Ajustar estilos de los botones de idioma
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600/10');
            });
            document.getElementById(`btn-lang-${lang}`).classList.add('active');

            // Actualizar placeholders din√°micos de inputs principales seg√∫n el modo
            updateDynamicLabels();
        }

        // 2. Controlador de Modos (Mes/Semana/Horas)
        function setMode(mode) {
            currentMode = mode;
            const modes = ['mes', 'semana', 'horas'];
            
            modes.forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                if (m === mode) {
                    btn.className = "flex-1 py-3 rounded-xl bg-blue-600 font-bold text-[10px] uppercase transition-all";
                } else {
                    btn.className = "flex-1 py-3 rounded-xl font-bold text-slate-500 text-[10px] uppercase transition-all hover:text-slate-300";
                }
            });
            updateDynamicLabels();
        }

        function updateDynamicLabels() {
            const lblGross = document.getElementById('lbl-gross');
            const lblTime = document.getElementById('lbl-time');
            
            if (currentMode === 'horas') {
                lblGross.textContent = (currentLang === 'en') ? "Hourly Rate" : (currentLang === 'it') ? "Tariffa Oraria" : (currentLang === 'pt') ? "Valor Hora" : "Precio / Hora";
                lblTime.textContent = (currentLang === 'en') ? "Total Hours" : (currentLang === 'it') ? "Ore Totali" : (currentLang === 'pt') ? "Total de Horas" : "Total de Horas";
            } else {
                lblGross.textContent = translations[currentLang]['lbl_gross'];
                lblTime.textContent = translations[currentLang]['lbl_time'];
            }
        }

        // 3. L√≥gica de Pesta√±as Avanzadas (Independiente del idioma)
        function toggleAdvanced() {
            const container = document.getElementById('advanced-container');
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden')) {
                updateAdvancedVisibility();
            }
        }

        function updateAdvancedVisibility() {
            const country = document.getElementById('country-select').value;
            // Ocultar todos los subpaneles
            document.querySelectorAll('.adv-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            // Mostrar solo el del pa√≠s seleccionado
            const activePanel = document.getElementById(`adv-${country}`);
            if (activePanel) {
                activePanel.classList.remove('hidden');
            }
        }

        // 4. Controlador de C√°lculos y Publicidad
        function triggerCalculation() {
            calculationCount++;
            
            // L√≥gica: Mostrar anuncio en el 1er c√°lculo y luego en los impares (1, 3, 5...)
            if (calculationCount === 1 || calculationCount % 2 !== 0) {
                showAdAndCalculate();
            } else {
                executeMath();
            }
        }

        function showAdAndCalculate() {
            const overlay = document.getElementById('ad-overlay');
            const timerEl = document.getElementById('ad-timer');
            let timeLeft = 5;
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            timerEl.textContent = timeLeft;

            const countdown = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    executeMath();
                }
            }, 1000);
        }

        // 5. Motor Matem√°tico Central
        function executeMath() {
            const country = document.getElementById('country-select').value;
            const inputBase = Math.abs(parseFloat(document.getElementById('input-gross').value)) || 0;
            const inputTime = Math.abs(parseFloat(document.getElementById('input-time').value)) || 0;
            const currency = (country === 'UK') ? '¬£' : '‚Ç¨';

            // Determinar bruto total
            let grossTotal = (currentMode === 'horas') ? (inputBase * inputTime) : inputBase;
            let ssAmount = 0;
            let taxAmount = 0;

            // F√≥rmulas por pa√≠s
            if (country === 'ES') {
                ssAmount = grossTotal * 0.0647;
                const manualTax = parseFloat(document.getElementById('es-irpf-val').value);
                if (!isNaN(manualTax)) {
                    taxAmount = grossTotal * (manualTax / 100);
                } else {
                    taxAmount = (grossTotal > 2500) ? grossTotal * 0.19 : grossTotal * 0.15;
                }
            } 
            else if (country === 'UK') {
                const isSecondJob = document.getElementById('uk-2job-val').checked;
                const pensionRate = (parseFloat(document.getElementById('uk-pension-val').value) || 5) / 100;
                
                // National Insurance (Approximate logic)
                ssAmount = (grossTotal > 1048) ? (grossTotal - 1048) * 0.08 : 0;
                ssAmount += (grossTotal * pensionRate); // Summing pension to deductions

                // Income Tax (BR code for 2nd job is flat 20%)
                if (isSecondJob) {
                    taxAmount = grossTotal * 0.20;
                } else {
                    taxAmount = (grossTotal > 1047) ? (grossTotal - 1047) * 0.20 : 0;
                }
            } 
            else if (country === 'IT') {
                ssAmount = grossTotal * 0.0919;
                const regRate = parseFloat(document.getElementById('it-reg-val').value) || 1.23;
                const comRate = parseFloat(document.getElementById('it-com-val').value) || 0.8;
                // Base IRPEF (23%) + Regional + Comunale
                taxAmount = (grossTotal * 0.23) + (grossTotal * (regRate / 100)) + (grossTotal * (comRate / 100));
            } 
            else if (country === 'PT') {
                ssAmount = grossTotal * 0.11;
                const maritalStatus = document.getElementById('pt-status-val').value;
                const dependents = parseInt(document.getElementById('pt-dep-val').value) || 0;
                
                // IRS simplificado basado en estado civil y dependientes
                let baseIrsRate = (maritalStatus === 'casado') ? 0.12 : 0.145;
                let finalIrsRate = Math.max(0, baseIrsRate - (dependents * 0.015));
                taxAmount = grossTotal * finalIrsRate;
            }

            const netTotal = grossTotal - ssAmount - taxAmount;

            // Renderizar Resultados
            document.getElementById('out-gross').textContent = grossTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + currency;
            document.getElementById('out-ss').textContent = "-" + ssAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + currency;
            document.getElementById('out-tax').textContent = "-" + taxAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + currency;
            document.getElementById('out-net').textContent = netTotal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + currency;

            // Mostrar Tarjeta y hacer scroll
            const resCard = document.getElementById('results-card');
            resCard.classList.remove('hidden');
            setTimeout(() => {
                resCard.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        // Inicializaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            setLanguage('es');
            // Asegurarse de que el pa√≠s por defecto es Espa√±a para que coincida con el HTML
            document.getElementById('country-select').value = 'ES';
            // Configurar placeholder para el IRPF espa√±ol a su estado inicial
            document.getElementById('es-irpf-val').placeholder = "Auto (15-19%)";
        });
    </script>
</body>
</html>
